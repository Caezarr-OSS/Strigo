name: Release

on:
  push:
    tags:
      - "*"  

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: strigo
  CGO_ENABLED: "0"

jobs:
  build-and-package:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21.x"

      - name: Pre-fetch modules
        run: go mod download

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          set -euo pipefail
          OUTDIR=dist
          mkdir -p "$OUTDIR"
          SUFFIX="${GOOS}-${GOARCH}"
          BIN="${APP_NAME}-${SUFFIX}"
          # Build ONLY the root main package; ./... would span multiple packages and break -o <file>
          go build -trimpath -ldflags="-s -w" -o "${BIN}" .
          TAR="${OUTDIR}/${APP_NAME}_${SUFFIX}.tar.gz"
          tar -czf "${TAR}" "${BIN}"
          rm -f "${BIN}"
          echo "Built ${TAR}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-{1}', matrix.goos, matrix.goarch) }}
          path: dist/*.tar.gz
          if-no-files-found: error
          retention-days: 7

  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build-and-package]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for tag checks and changelog

      - name: Ensure tag commit is reachable from main
        shell: bash
        run: |
          git fetch --no-tags --prune origin +refs/heads/main:refs/remotes/origin/main
          if ! git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "❌ The tag must point to a commit that is contained in 'main'."
            exit 1
          fi

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          # Download all artifacts from all matrix legs into ./dist
          path: dist
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -lah dist

      - name: Generate checksums (SHA-256)
        run: |
          set -euo pipefail
          (cd dist && sha256sum *.tar.gz > checksums.txt)
          echo "Checksums:"
          cat dist/checksums.txt

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          path: dist
          upload-artifact: false
          format: cyclonedx-json
          output-file: sbom.json

      - name: Install git-chglog (stable v0.15.4)
        run: |
          set -euo pipefail
          go install github.com/git-chglog/git-chglog/cmd/git-chglog@v0.15.4
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Generate CHANGELOG for this tag (existing tag mode)
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ -f .chglog/config.yml ]; then
            # Render entry for the EXISTING tag (no --next-tag, no --tag)
            git-chglog --config .chglog/config.yml "$TAG" > CHANGELOG.md
          else
            echo "NOTE: .chglog/config.yml not found. Skipping git-chglog." > CHANGELOG.md
          fi

      - name: Create/Update GitHub Release (single, race-free)
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ${{ github.ref_name }}
          files: |
            dist/*.tar.gz
            dist/checksums.txt
            sbom.json
            CHANGELOG.md
          generate_release_notes: false
